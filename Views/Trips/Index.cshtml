@model List<TripViewModel>
@using TravelExpenseTracker.Domain

@{
    ViewData["Title"] = "All Trips";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
        <h1>All Trips</h1>
        <a asp-area="" asp-controller="Trips" asp-action="Create" class="btn btn-success">Create New Trip</a>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            <h4>No Trips Found</h4>
            <p>You haven't created any trips yet.</p>
            <a asp-area="" asp-controller="Trips" asp-action="Create" class="btn btn-primary">Create Your First Trip</a>
        </div>
    }
    else
    {
        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">@Model.Count</h3>
                        <small class="text-muted">Total Trips</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-success">@Model.Sum(t => t.ExpenseSummary.TotalAmount).ToString("C")</h3>
                        <small class="text-muted">Total Spent</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-info">@Model.Sum(t => t.ExpenseSummary.TotalExpenses)</h3>
                        <small class="text-muted">Total Expenses</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-secondary">@(Model.Average(t => t.ExpenseSummary.TotalAmount).ToString("C"))</h3>
                        <small class="text-muted">Average per Trip</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trips Table -->
        <div class="card">
            <div class="card-header bg-dark">
                <h5 class="mb-0 text-white">Trip List</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Trip Name</th>
                            <th>Destination</th>
                            <th>Dates</th>
                            <th>Duration</th>
                            <th class="text-center">Expenses</th>
                            <th class="text-end">Total Amount</th>                            
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tripViewModel in Model.OrderByDescending(t => t.Trip.StartDate))
                        {
                            var trip = tripViewModel.Trip;
                            var summary = tripViewModel.ExpenseSummary;
                            var duration = (trip.EndDate - trip.StartDate).Days + 1;
                            var dailyAverage = duration > 0 ? summary.TotalAmount / duration : 0;

                            <tr>
                                <td>
                                    <div>
                                        <strong>@trip.Name</strong>
                                        @if (!string.IsNullOrEmpty(trip.Description))
                                        {
                                            <br>

                                            <small class="text-muted">@trip.Description</small>
                                        }
                                    </div>
                                </td>
                                <td>@(trip.Destination ?? "—")</td>
                                <td>
                                    <div>
                                        @trip.StartDate.ToString("MMM dd")
                                        <br><small class="text-muted">to @trip.EndDate.ToString("MMM dd, yyyy")</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">@duration days</span>
                                </td>
                                <td class="text-center">
                                    @if (summary.TotalExpenses > 0)
                                    {
                                        <span class="badge bg-primary">@summary.TotalExpenses</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">0</span>
                                    }
                                </td>
                                <td class="text-end">
                                    @if (summary.TotalAmount > 0)
                                    {
                                        <strong class="text-success">@summary.TotalAmount.ToString("C")</strong>
                                    }
                                    else
                                    {
                                        <span class="text-muted">$0.00</span>
                                    }
                                </td>                               
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <a asp-area="" asp-controller="Trips" asp-action="Details" asp-route-id="@trip.Id"
                                           class="btn btn-outline-primary" title="View Details">
                                            View
                                        </a>
                                        <a asp-area="" asp-controller="Trips" asp-action="Edit" asp-route-id="@trip.Id"
                                           class="btn btn-outline-success" title="Edit">
                                            Edit
                                        </a>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                More
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" asp-area="" asp-controller="Expenses" asp-action="Create" asp-route-tripId="@trip.Id">Add Expense</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item text-danger" data-trip-id="@trip.Id" data-trip-name="@trip.Name"
                                                       onclick="deleteExpense(this)">Delete Trip</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

    }
</div>

<!--hidden form to trigger a post for the delete link-->
<!--This technique keeps the style for the group buttons</style>-->
<form id="deleteForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>
<script>
    function deleteExpense(element) {       
        var tripName = element.getAttribute('data-trip-name');
        var tripId = element.getAttribute('data-trip-id');

        if (confirm('Are you sure you want to delete ' + tripName + '? This will also delete all associated expenses.')) {
            var form = document.getElementById('deleteForm');
            form.action = '@Url.Action("Delete", "Trips")/' + tripId;
            form.submit();
        }
    }
</script>
